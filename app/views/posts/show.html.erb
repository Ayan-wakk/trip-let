<div class="w-screen sm:max-w-7xl mx-auto px-6 py-12 mt-6 rounded-3xl border border-gray-200 shadow-inner"
     style="background-color: #ffffff;
            background-image:
              linear-gradient(rgba(120, 110, 100, 0.15) 1px, transparent 1px),
              linear-gradient(90deg, rgba(120, 110, 100, 0.15) 1px, transparent 1px);
            background-size: 1.5rem 1.5rem;">
  
  <div class="flex flex-col sm:flex-row gap-10 items-start">

    <!-- å·¦ï¼šç”»åƒã‚¨ãƒªã‚¢ -->
    <% if @post.images.attached? %>
      <div class="sm:w-3/5">

        <!-- ãƒ¡ã‚¤ãƒ³ç”»åƒ  -->
        <div class="relative mx-auto w-fit rotate-[-2deg]">
          <%= image_tag @post.images.first.variant(
                resize_to_limit: [800, 800], format: :webp).processed,
                id: "main-image",
                loading: "eager",
                decoding: "async",
                class: "h-[520px] w-auto object-contain bg-white p-5
                        rounded-sm border border-gray-200 shadow-[0_12px_30px_rgba(0,0,0,0.25)]" %>

          <!-- ãƒã‚¹ã‚­ãƒ³ã‚°ãƒ†ãƒ¼ãƒ— -->
          <span class="absolute -top-5 left-1/2 -translate-x-1/2
                       w-50 h-9
                       rotate-[-2deg]
                       z-20
                       rounded-[4px]
                       opacity-95
                       bg-[#c3d2a4]
                       shadow-[0_3px_6px_rgba(0,0,0,0.22)]
                       before:absolute before:inset-0
                       before:bg-[repeating-linear-gradient(
                       -45deg,
                       rgba(255,255,255,0.2),
                       rgba(255,255,255,0.2)_2px,
                       transparent_2px,
                       transparent_4px
                       )]
                       before:rounded-[4px]
                       after:absolute after:inset-0
                       after:border after:border-white/25
                       after:rounded-[4px]
                       ">
           </span>

          <!-- å·¦çŸ¢å° -->
          <button
            id="prev-image"
            class="absolute left-2 top-1/2 -translate-y-1/2
                   bg-white/80 hover:bg-white rounded-full p-2 shadow">
          â—€
          </button>

          <!-- å³çŸ¢å° -->
          <button
            id="next-image"
            class="absolute right-2 top-1/2 -translate-y-1/2
                   bg-white/80 hover:bg-white rounded-full p-2 shadow">
          â–¶
          </button>
        </div>

        <!-- ã‚µãƒ ãƒã‚¤ãƒ« -->
        <div class="mt-12 flex gap-2 overflow-x-auto">
          <% @post.images.each_with_index do |image, index| %>
            <% main_variant = image.variant(resize_to_limit: [800, 800], format: :webp).processed %>

            <%= image_tag image.variant(resize_to_fill:[200, 200], format: :webp).processed,
              class: "thumbnail h-24 w-24 object-cover rounded-lg shrink-0 border
                      cursor-pointer #{index == 0 ? 'ring-2 ring-black' : ''}",
              data: { image_url: url_for(main_variant) } %>
          <% end %>
        </div>

      </div>
    <% end %>

    <!-- å³ï¼šãƒ†ã‚­ã‚¹ãƒˆ -->
    <div class="sm:w-2/5 p-6 space-y-4 rounded-2xl overflow-auto max-h-[90vh]">

      <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
      <h1 class="py-4 text-3xl font-normal text-stone-700 font-zenmaru
           inline
           bg-[linear-gradient(transparent_60%,_#7CFF6B_60%)]
           bg-no-repeat
           bg-[length:100%_0.75em]
           bg-[position:0_1.2em]
           [box-decoration-break:clone]
           [-webkit-box-decoration-break:clone]">
        <%= @post.title %>
      </h1>

      <!-- ãƒ¡ã‚¿æƒ…å ± -->
      <div class="px-1 space-y-1 text-lg text-stone-600 font-zenmaru">
        <% if @post.visited_at.present? %>
          <div class="flex items-center">
            <span class="w-16 shrink-0">è¨ªå•æ—¥</span>
            <span><%= @post.visited_at %></span>
         </div>
        <% end %>

        <div class="flex items-center font-zenmaru">
          <span class="shrink-0 text-lg me-2">å ´æ‰€ã€€â¡</span>
          <span class="font-medium">
            <%= country_name(@post.country) %>
            <% if @post.region.present? %>
              / <%= @post.region %>
            <% end %>
          </span>
        </div>
      </div>

      <!-- æ„Ÿæƒ³ãƒ»ãƒ¡ãƒ¢ -->
      <div class="pt-2 px-1 pb-6 ml-4 text-xl text-stone-700
                  leading-[2.2rem] whitespace-pre-line font-zenmaru">
        <%= @post.body %>
      </div>

      <!-- çŸ¥ã£ã¦ãŠãã¨ä¾¿åˆ© -->
      <% if @post.warning.present? %>
        <div class="mt-10 pt-5 px-6 pb-10 bg-sky-50 rounded-2xl relative overflow-hidden">
          <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-sky-500"></div>

          <h2 class="flex items-center font-bold text-sky-600 text-xl tracking-wider uppercase mb-2">
            <span class="mr-2">ğŸ’¡çŸ¥ã£ã¦ãŠãã¨ä¾¿åˆ©</span> 
          </h2>
    
          <div class="mb-4 w-full border-t border-sky-200 border-dotted"></div>
    
          <p class="whitespace-pre-line text-xl text-gray-700 leading-relaxed font-medium font-zenmaru">
            <%= @post.warning %>
          </p>
        </div>
      <% end %>

      <!-- æŠ•ç¨¿è€…æƒ…å ± ã„ãšã‚Œè¿½åŠ ã™ã‚‹ -->
      <div class="flex items-center mt-6 space-x-3">
      </div>

      <!-- ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³(æŠ•ç¨¿è€…ã®ã¿) -->
      <% if user_signed_in? && current_user == @post.user %>
        <div class="flex flex-col gap-3">
          <%= link_to "ç·¨é›†", edit_post_path(@post),
              class: "w-full px-4 py-2 bg-sky-500 hover:bg-sky-400 text-center text-white rounded-lg" %>
          <%= link_to "å‰Šé™¤", post_path(@post),
              method: :delete,
              data: { turbo_method: :delete, turbo_confirm: "æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ" },
              class: "w-full px-4 py-2 border-2 bg-gray-300 hover:bg-gray-400 hover:text-white text-center rounded-lg" %>
        </div>
      <% end %>
    </div>
  </div>
</div>


<script>
  document.addEventListener("turbo:load", () => {
    const mainImage = document.getElementById("main-image");
    if (!mainImage) return;

    const thumbnails = Array.from(document.querySelectorAll(".thumbnail"));
    if (thumbnails.length === 0) return;

    const prevBtn = document.getElementById("prev-image");
    const nextBtn = document.getElementById("next-image");

    let currentIndex = thumbnails.findIndex(t =>
      t.classList.contains("ring-2")
    );
    if (currentIndex === -1) currentIndex = 0;

    function preload(index) {
      if (!thumbnails[index]) return;
      const img = new Image();
      img.src = thumbnails[index].dataset.imageUrl;
    }

    function updateImage(index) {
      if (!thumbnails[index]) return;
      const thumbnail = thumbnails[index];
      mainImage.src = thumbnail.dataset.imageUrl;

      thumbnails.forEach(t =>
        t.classList.remove("ring-2", "ring-black")
      );
      thumbnail.classList.add("ring-2", "ring-black");

      currentIndex = index;

      // æ¬¡ã¨å‰ã‚’å…ˆèª­ã¿
      preload((index + 1) % thumbnails.length);
      preload((index - 1 + thumbnails.length) % thumbnails.length);
    }

    thumbnails.forEach((thumbnail, index) => {
      thumbnail.addEventListener("click", () => {
        updateImage(index);
      });
    });

    if (prevBtn) {
      prevBtn.addEventListener("click", () => {
        updateImage(
          currentIndex === 0 ? thumbnails.length - 1 : currentIndex - 1
        );
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener("click", () => {
        updateImage(
          currentIndex === thumbnails.length - 1 ? 0 : currentIndex + 1
        );
      });
    }

    // åˆæœŸè¡¨ç¤ºæ™‚ã‚‚å…ˆèª­ã¿
    preload((currentIndex + 1) % thumbnails.length);
    preload((currentIndex - 1 + thumbnails.length) % thumbnails.length);
  });
</script>
